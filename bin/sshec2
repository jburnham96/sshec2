#!/bin/bash

source /etc/sshec2.conf

if [[ -z "${aws_cluster_incl// }" ]]
then
	ALLSERVERDETAIL=$(aws ec2 describe-instances --query "Reservations[*].Instances[*].{name: Tags[?Key=='Name'] | [0].Value, IP: PrivateIpAddress, ImageId: ImageId, Time: LaunchTime}")
else
	ALLSERVERDETAIL=$(aws ec2 describe-instances --query "Reservations[*].Instances[*].{name: Tags[?Key=='Name'] | [0].Value, IP: PrivateIpAddress, ImageId: ImageId, Time: LaunchTime}" --filter Name=tag:Cluster,Values=$aws_cluster_incl)
fi

SERVERNAMES=$(echo "$ALLSERVERDETAIL" | jq '.[] | .[].name' | sed 's/ /_/g')

SELECTEDNO=-1

names=($SERVERNAMES)
select name in "${names[@]}"; do	
    echo "You have chosen $name"
    let "ARRID = $REPLY - 1"
    break
done

SERVERIP=$(echo "$ALLSERVERDETAIL" | jq -r --arg id "$ARRID" '.[$id | tonumber] | .[].IP')
echo -e "\e[38;5;82mConnecting to $SERVERIP\e[0m"

ssh -i $aws_key_location -oStrictHostKeyChecking=no ec2-user@$SERVERIP
